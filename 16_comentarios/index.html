<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>16. Comentarios - Django</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "16. Comentarios";
    var mkdocs_page_input_path = "16_comentarios.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../00_por_que_django/">¿Por qué Django?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../01_introduccion/">1. Introducción</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../02_configuracion_inicial/">2. Configuración Inicial</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../03_hello_world_app/">3. Hello World app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../04_pages_app/">4. Pages app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../05_message_board_app/">5. Message Board app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../06_blog_app/">6. Blog app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../07_formularios/">7. Formularios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../08_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../09_modelo_de_usuario_personalizado/">9. Modelo de Usuario Personalizado</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../11_bootstrap/">11. Bootstrap</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../13_email/">13. Email</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../14_newspaper_app/">14. Newspaper app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../15_permisos_y_autorizacion/">15. Permisos y Autorización</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">16. Comentarios</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#161-modelo">16.1. Modelo</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#164-admin">16.4 Admin</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#165-plantilla">16.5. Plantilla</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#conclusion">Conclusión</a>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>16. Comentarios</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="16-comentarios">16. Comentarios</h1>
<ul>
<li>Dos maneras:</li>
<li>Crear una aplicación de comentarios dedicada y enlazarla a los artículos (sobreingeniería en este momento).</li>
<li>Añadir un modelo adicional llamado <code>Comment</code> a la aplicación de artículos y enlazarlo al modelo de Artículo a través de una clave externa.</li>
<li>Los usuarios también tendrán la posibilidad de dejar comentarios en los artículos de cualquier otro usuario.</li>
</ul>
<h2 id="161-modelo">16.1. Modelo</h2>
<ul>
<li>Añadir otra tabla a nuestra base de datos existente llamada <code>Comment</code>.<ul>
<li>Tendrá una relación muchos a uno de clave primaria con <code>Article</code>: un artículo puede tener muchos comentarios, pero no al revés. Tradicionalmente el nombre del campo de la clave foránea es simplemente el modelo con el que se vincula, por lo que este campo se llamará <code>article</code>. Los otros dos campos serán <code>comment</code> y <code>author</code>.</li>
</ul>
</li>
</ul>
<p>FICHERO: <code>articles/models.py</code></p>
<pre><code>...
class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    comment = models.CharField(max_length=140)
    author = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
    )

    def __str__(self):
        return self.comment

    def get_absolute_url(self):
        return reverse('article_list')
</code></pre>
<ul>
<li>El modelo <code>Comment</code> tiene un método <code>__str__</code> y un método <code>get_absolute_url</code> que regresa a la página principal <code>articles/</code>.</li>
<li>Ya que se han actualizado los modelos, es hora de hacer un nuevo archivo de migración y luego aplicarlo.<ul>
<li>Al añadir <code>articles</code> al final de cada comando, lo cual es opcional, estamos especificando que queremos usar sólo la aplicación de artículos. Esto es un buen hábito.</li>
<li>Por ejemplo, ¿qué pasaría si se hicieran cambios en los modelos de dos aplicaciones diferentes? Si no especificamos una aplicación, entonces los cambios de ambas aplicaciones se incorporarán en el mismo archivo de migraciones, lo que hace más difícil, en el futuro, depurar los errores. Manténgase cada migración tan pequeña y contenida como sea posible.</li>
</ul>
</li>
</ul>
<pre><code class="language-bash">(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
</code></pre>
<h2 id="164-admin">16.4 Admin</h2>
<ul>
<li>Después de crear un nuevo modelo es bueno jugar con él en la aplicación de administración antes de mostrarlo en el sitio web real. Añadir el <code>Comment</code> al archivo <code>admin.py</code> para que sea visible.</li>
</ul>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code class="language-python">from django.contrib import admin
from . import models

admin.site.register(models.Article)
admin.site.register(models.Comment)
</code></pre>
<ul>
<li>En este punto se podríamos añadir un campo de administración adicional para ver el comentario y el artículo en la página de administración de Django. ¿Pero no sería mejor ver todos los modelos de <code>Comment</code> relacionados con un solo modelo <code>Post</code>? Resulta que sí, con una función de administración de Django llamada <strong>inlines</strong> que muestra las relaciones de claves externas de una manera más visual y agradable.</li>
<li>Hay dos vistas <strong>inlines</strong> principales: <code>TabularInline</code> y <code>StackedInline</code>. La única diferencia entre las dos es el modelo para mostrar la información. En una <code>TabularInline</code> todos los campos del modelo aparecen en una línea mientras que en una <code>StackedInline</code> cada campo tiene su propia línea.</li>
<li>Se implementarán las dos para decidir cuál se prefiere</li>
</ul>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code class="language-python">from django.contrib import admin
from . import models


class CommentInline(admin.StackedInline):
    model = models.Comment


class ArticleAdmin(admin.ModelAdmin):
    inlines = [
        CommentInline,
    ]


admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
</code></pre>
<ul>
<li>Se pueden ver y modificar todos los artículos y comentarios relacionados en un solo lugar.</li>
<li>En caso de usar  <code>TabularInline</code> se muestra más información en menos espacio. Para cambiar a él sólo hay que cambiar <code>CommentInline</code> de <code>admin.StackedInline</code> a <code>admin.TabularInline</code>.</li>
</ul>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code class="language-python">from django.contrib import admin
from . import models


class CommentInline(admin.TabularInline):
    model = models.Comment


class ArticleAdmin(admin.ModelAdmin):
    inlines = [
        CommentInline,
    ]


admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
</code></pre>
<ul>
<li>Ver lo cambios en la página de administración de Django: todos los campos de cada modelo se muestran en la misma línea.</li>
</ul>
<h2 id="165-plantilla">16.5. Plantilla</h2>
<ul>
<li>Dado que <code>Comment</code> vive dentro de la app <code>articles</code> existente, sólo necesitamos actualizar las plantillas existentes para <code>article_list.html</code> y <code>article_detail.html</code> para mostrar el nuevo contenido. No hay que crear nuevas plantillas y jugar con las urls y las vistas.</li>
<li>Lo que se quiere hacer es mostrar <strong>todos</strong> los comentarios relacionados con un artículo específico. Esto se llama "query" ya que estamos pidiendo a la base de datos una información específica. En este caso, al trabajar con una clave rofánea, se busca seguir una relación hacia atrás: para cada <code>Article</code> buscar modelos de <code>Comment</code> relacionados.</li>
<li>Django tiene una sintaxis incorporada que se puede usar conocida como <code>FOO_set</code> donde <code>FOO</code> es el nombre del modelo fuente en minúsculas. Así que para el modelo de <code>Article</code> se puede usar <code>article_set</code> para acceder a todas las instancias del modelo.</li>
<li>Esta sintaxis es un poco confusa y no intuitiva. Un mejor enfoque es añadir un atributo <code>related_name</code> al modelo que permita establecer explícitamente el nombre de esta relación inversa en su lugar. Hagámoslo.</li>
<li>Para empezar, agregar un atributo <code>related_name</code> al modelo de comentarios. Un buen valor por defecto es nombrarlo en el plural del modelo que contiene la clave foránea.</li>
</ul>
<p>FICHERO: <code>articles/models.py</code></p>
<pre><code>...
class Comment(models.Model):
    article = models.ForeignKey(
        Article,
        on_delete=models.CASCADE,
        related_name='comments' # new
)
</code></pre>
<ul>
<li>Como se acaba de hacer un cambio en el modelo de base de datos, se necesita crear un archivo de migraciones y actualizar la base de datos.</li>
</ul>
<pre><code class="language-bash">(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
(news) $ python manage.py runserver
</code></pre>
<ul>
<li>Entender las consultas lleva algún tiempo, así que no preocuparse si la idea de las relaciones inversas es confusa. Y una vez que se dominen estos casos básicos, se puede explorar cómo filtrar  consultas con gran detalle para que devuelvan exactamente la información que se desea.</li>
<li>En el archivo <code>article_list.html</code> se pueden añadir los comentarios a <code>card-footer</code>. Notar que se han movido los enlaces de edición y borrado a <code>card-body</code>. Para acceder a cada comentario se llama a <code>article.comments.all</code> lo que significa que primero se mira el modelo <code>article</code>, luego <code>comment</code> que es el nombre relacionado a todo el modelo <code>Comment</code>, y se selecciona <code>all included</code>. ¡Puede llevar un poco de tiempo acostumbrarse a esta sintaxis para referenciar datos de claves foráneas en una plantilla!</li>
</ul>
<p>FICHERO: <code>template/article_list.html</code></p>
<pre><code class="language-html">{% extends 'base.html' %}

{% block title %}Articles{% endblock %}

{% block content %}
  {% for article in object_list %}
    &lt;div class=&quot;card&quot;&gt;
      &lt;div class=&quot;card-header&quot;&gt;
        &lt;span class=&quot;font-weight-bold&quot;&gt;{{ article.title }}&lt;/span&gt; &amp;middot;
        &lt;span class=&quot;text-muted&quot;&gt;by {{ article.author }} | {{ article.date }}&lt;/span&gt;
      &lt;/div&gt;
      &lt;div class=&quot;card-body&quot;&gt;
        &lt;p&gt;{{ article.body }}&lt;/p&gt;
        &lt;a href=&quot;{% url 'article_edit' article.pk %}&quot;&gt;Edit&lt;/a&gt; |
        &lt;a href=&quot;{% url 'article_delete' article.pk %}&quot;&gt;Delete&lt;/a&gt;
      &lt;/div&gt;
      &lt;div class=&quot;card-footer&quot;&gt;
        {% for comment in article.comments.all %}
          &lt;p&gt;
            &lt;span class=&quot;font-weight-bold&quot;&gt;{{ comment.author }} &amp;middot;&lt;/span&gt;
            {{ comment }}
          &lt;/p&gt;
        {% endfor %}
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;br /&gt;
  {% endfor %}
{% endblock content %}
</code></pre>
<h2 id="conclusion">Conclusión</h2>
<ul>
<li>Con más tiempo habría que centrarse en los formularios para que un usuario pueda escribir un nuevo artículo directamente en la página de artículos, así como añadir también comentarios. Pero el principal objetivo de este capítulo es demostrar cómo funcionan las relaciones de clave foránea en Django.</li>
<li>La aplicación para el periódico ya está completa.<ul>
<li>Tiene un flujo de autenticación de usuario robusto, incluyendo el uso del correo electrónico para el restablecimiento de la contraseña.</li>
<li>También se utiliza un modelo de usuario personalizado, por lo que si se quiere añadir campos adicionales al modelo de usuario personalizado es tan sencillo como añadir un campo adicional. Ya tenemos un campo de edad para todos los usuarios que está siendo configurado por defecto. </li>
<li>Se podría añadir un desplegable de edad al formulario de registro y restringir el acceso de los usuarios sólo a los mayores de 13 años. O se podría ofrecer descuentos a los usuarios mayores de 65 años. Lo que se quiera hacer con el modelo de usuario personalizado es una opción.</li>
</ul>
</li>
<li>La mayor parte del desarrollo web sigue los mismos patrones y al utilizar un framework como Django el 99% de lo que se quiera en términos de funcionalidad ya está incluido o sólo falta una pequeña personalización de alguna función existente.</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../15_permisos_y_autorizacion/" class="btn btn-neutral" title="15. Permisos y Autorización"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../15_permisos_y_autorizacion/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
