<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Permisos y Autorización - Django</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Permisos y Autorizaci\u00f3n";
    var mkdocs_page_input_path = "15.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../1_introduccion/">1. Introducción</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../2_configuracion_inicial/">2. Configuración Inicial</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../3_hello_world_app/">3. Hello World app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../4_pages_app/">4. Pages app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../5_message_board_app/">5. Message Board app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../6_blog_app/">6. Blog app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../7_formularios/">7. Formularios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../8_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../9_modelo_de_usuario_personalizado/">9. Modelo de Usuario Personalizado</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../11_bootstrap/">11. Bootstrap</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../13_email/">13. Email</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../14_newspaper_app/">14. Newspaper app</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Permisos y Autorización</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="permisos-y-autorizacion">Permisos y Autorización</h1>
<p>Hay varios problemas con nuestro actual sitio web del periódico. Por un lado, queremos que nuestro periódico sea financieramente sostenible. Con más tiempo podríamos añadir una aplicación de pago para cobrar por el acceso, pero por ahora requeriremos que un usuario se registre para ver cualquier artículo. Esto se conoce como autorización. Es común establecer diferentes reglas acerca de quién está autorizado para ver áreas de su sitio. Tenga en cuenta que esto es diferente de la autenticación, que es el proceso de registro e inicio de sesión de los usuarios. La autorización restringe el acceso; la autenticación permite el flujo de registro e inicio de sesión de un usuario.
Como marco web maduro, Django tiene incorporada una funcionalidad de autorización que podemos utilizar rápidamente. En este capítulo limitaremos el acceso a varias páginas sólo a los usuarios que hayan iniciado la sesión. También añadiremos permisos para que sólo el autor de un artículo pueda actualizarlo o borrarlo; ¡ahora cualquier usuario puede hacerlo!
Mejora de CreateView
En la actualidad el autor de un nuevo artículo puede ser fijado a cualquier usuario. En cambio, debería ser automáticamente establecido al usuario actual. Entonces estableceremos permisos de edición/borrado para que sólo el autor de un artículo pueda hacer tales cambios. El CreateView por defecto nos proporciona una gran funcionalidad pero para establecer el usuario actual como autor necesitaremos personalizarlo. Eliminaremos el autor de los campos y en su lugar lo estableceremos automáticamente a través del método form_valid.</p>
<p>FICHERO: <code>articles/views.py</code></p>
<pre><code>...
class ArticleCreateView(CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body']
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
...
</code></pre>

<p>¿Cómo supe que podía actualizar CreateView de esta manera? La respuesta es que miré el código fuente y usé Google. Las vistas genéricas basadas en clases son increíbles para empezar nuevos proyectos, pero cuando quieres personalizarlas, es necesario arremangarse y empezar a entender lo que pasa bajo el capó. Cuanto más uses y personalices las vistas incorporadas, más cómodo te sentirás haciendo personalizaciones como esta. Lo más probable es que lo que estás intentando hacer ya haya sido resuelto en algún lugar, ya sea dentro de Django mismo o en un foro como Stack Overflow. No tengas miedo de pedir ayuda!
Ahora recarga el navegador e intenta hacer clic en el enlace "+ Nuevo" en la parte superior de la pantalla. Se redirigirá a la página de creación actualizada donde el autor ya no es un campo. Si creas un nuevo artículo y luego entras en el administrador verás que se establece automáticamente en el usuario actual conectado.
Enlace a un nuevo artículo
Autorizaciones
Hay múltiples problemas en torno a la falta de autorizaciones en nuestro proyecto actual. Obviamente nos gustaría restringir el acceso sólo a los usuarios para tener la opción de cobrar un día a los lectores de nuestro periódico. Pero más allá de eso, cualquier usuario desconectado al azar que conozca la URL correcta puede acceder a cualquier parte del sitio.
Considere lo que sucedería si un usuario desconectado intentara crear un nuevo artículo. Para probarlo, haga clic en su nombre de usuario en la esquina superior derecha de la barra de navegación, y luego seleccione "Cerrar sesión" en las opciones desplegables. El enlace "+ Nuevo" desaparece de la barra de navegación, pero ¿qué pasa si vas directamente a él: http://127.0.0.1:8000/articles/new/?
La página sigue ahí.
Desconexión nueva
Ahora intenta crear un nuevo artículo con un título y un cuerpo. Haz clic en el botón "Guardar".
Crear error de página
Un error. Esto se debe a que nuestro modelo espera un campo de autor que está ligado al usuario actual conectado. Pero como no estamos conectados, no hay autor, y por lo tanto la presentación falla.
Mixins
Claramente queremos establecer algunas autorizaciones para que sólo los usuarios registrados puedan acceder al sitio. Para ello podemos utilizar un mixin, que es un tipo especial de herencia múltiple que Django utiliza para evitar la duplicación de código y permitir la personalización. Por ejemplo, el ListView genérico incorporado necesita una forma de devolver una plantilla. Pero también lo hace DetailView y, de hecho, casi todas las demás vistas. En lugar de repetir el mismo código en cada gran vista genérica, Django descompone esta funcionalidad en una "mezcla" conocida como TemplateResponseMixin. Tanto la Vista Lista como la Vista Detallada usan esta mezcla para mostrar la plantilla adecuada.
Si lees el código fuente de Django, que está disponible gratuitamente en Github, verás que se utilizan mixins por todas partes.
Para restringir el acceso a la vista a sólo los usuarios conectados, Django tiene un mixin LoginRequired que podemos utilizar. Es potente y extremadamente conciso.
Dentro del archivo existente articles/views.py, impórtalo en la parte superior y luego agrega LoginRequiredMixin a nuestro ArticleCreateView . Asegúrate de que el mixin esté a la izquierda de ListView para que sea leído primero. Queremos que el ListView ya sepa que pretendemos restringir el acceso.
Y eso es todo! Hemos terminado.</p>
<p>FICHERO: <code>articles/views.py</code></p>
<pre><code>from django.contrib.auth.mixins import LoginRequiredMixin # new
...
class ArticleCreateView(LoginRequiredMixin, CreateView): # new
...
</code></pre>

<p>Ahora regresa a la URL para crear nuevos mensajes en http://127.0.0.1:8000/articles/new/ y verás el siguiente error:
Página de error
¿Qué es lo que está pasando? Django nos ha redirigido automáticamente a la ubicación por defecto de la página de inicio de sesión que está en /cuentas/login, sin embargo, si recuerdas, en nuestros URLs a nivel de proyecto estamos usando usuarios/ como nuestra ruta. Por eso nuestra página de acceso está en users/login. Entonces, ¿cómo le decimos a nuestro ArticleCreateView sobre esto?
Si miras la documentación de la mezcla LoginRequired nos dice la respuesta. Podemos agregar una ruta de login_url para anular el parámetro por defecto. Estamos usando la URL con nombre de nuestra ruta de acceso aquí login .</p>
<p>FICHERO: <code>articles/views.py</code></p>
<pre><code>...
class ArticleCreateView(LoginRequiredMixin, CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body',]
login_url = 'login' # new
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
</code></pre>

<p>Pruebe el enlace para crear nuevos mensajes de nuevo: http://127.0.0.1:8000/articles/new/. Ahora redirige a los usuarios a la página de acceso. Tal como lo deseábamos. Actualizando las vistas Ahora vemos que restringir el acceso a las vistas es sólo cuestión de añadir LoginRequiredMixin al principio de todas las vistas existentes y especificar el login_url correcto. Vamos a actualizar el resto de las vistas de nuestros artículos ya que no queremos que un usuario pueda crear, leer, actualizar o borrar un mensaje si no está conectado.
El archivo completo views.py debería tener ahora este aspecto:</p>
<p>FICHERO: <code>articles/views.py</code></p>
<pre><code>from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import ListView, DetailView
from django.views.generic.edit import CreateView, UpdateView, DeleteView
from django.urls import reverse_lazy
from . import models
class ArticleListView(LoginRequiredMixin, ListView):
model = models.Article
template_name = 'article_list.html'
login_url = 'login'
class ArticleDetailView(LoginRequiredMixin, DetailView):
model = models.Article
template_name = 'article_detail.html'
login_url = 'login'
class ArticleUpdateView(LoginRequiredMixin, UpdateView):
model = models.Article
fields = ['title', 'body', ]
template_name = 'article_edit.html'
login_url = 'login'
class ArticleDeleteView(LoginRequiredMixin, DeleteView):
model = models.Article
template_name = 'article_delete.html'
success_url = reverse_lazy('article_list')
login_url = 'login'
class ArticleCreateView(LoginRequiredMixin, CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body', ]
login_url = 'login'
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
</code></pre>

<p>Adelante, juega con el sitio para confirmar que las redirecciones de acceso ahora funcionan como se esperaba. Si necesitas ayuda para recordar cuáles son las URL adecuadas, inicia sesión primero y escribe las URL de cada una de las rutas para crear, editar, borrar y todos los artículos.</p>
<h2 id="conclusion">Conclusión</h2>
<p>Nuestra aplicación para el periódico está casi terminada. Tenemos nuestros artículos correctamente configurados, hemos establecido permisos y autorizaciones, la autentificación de los usuarios está en buen estado. El último punto es añadir la posibilidad de que otros usuarios conectados dejen comentarios que cubriremos en el próximo capítulo.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
