<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>15 - Django</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "15";
    var mkdocs_page_input_path = "15.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../1_introduccion/">1. Introducción</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../2_configuracion_inicial/">2. Configuración Inicial</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../3_hello_world_app/">3. Hello World app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../4_pages_app/">4. Pages app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../5_message_board_app/">5. Message Board app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../6_blog_app/">6. Blog app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../7_formularios/">7. Formularios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../8_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../9_modelo_de_usuario_personalizado/">9. Modelo de Usuario Personalizado</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../11_bootstrap/">11. Bootstrap</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../13_email/">13. Email</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>15</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>Chapter
: Permissions and
Authorization
There are several issues with our current Newspaper website. For one thing we want
our newspaper to be financially sustainable. With more time we could add a payments
app to charge for access, but for now we will require a user to log in to view any
articles. This is known as authorization. It’s common to set different rules around who
is authorized to view areas of your site. Note that this is different than authentication
which is the process of registering and logging-in users. Authorization restricts
access; authentication enables a user signup and login flow.
As a mature web framework, Django has built-in functionality for authorization that
we can quickly use. In this chapter we’ll limit access to various pages only to logged-in
users. We will also add permissions so that only the author of an article can update
or delete it; right now any user can!
Improved CreateView
At present the author on a new article can be set to any user. Instead it should be
automatically set to the current user. Then we will set permissions on edit/delete
so that only the author of an article can make such changes. The default CreateView
provides a lot of functionality for us but in order to set the current user to author we
will need to customize it. We will remove author from the fields and instead set it
automatically via the form_valid method.Chapter 14: Permissions and Authorization
278
Code</p>
<h1 id="articlesviewspy">articles/views.py</h1>
<p>...
class ArticleCreateView(CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body']
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
...
How did I know I could update CreateView like this? The answer is I looked at the
source code and used Google. Generic class-based views are amazing for starting new
projects but when you want to customize them, it is necessary roll up your sleeves and
start to understand what’s going on under the hood. The more you use and customize
built-in views, the more comfortable you will become making customizations like this.
Chances are whatever you are trying to do has already been solved somewhere, either
within Django itself or on a forum like Stack Overflow. Don’t be afraid to ask for help!
Now reload the browser and try clicking on the “+ New” link in the top nav. It will
redirect to the updated create page where author is no longer a field. If you create
a new article and then go into the admin you will see it is automatically set to the
current logged-in user.Chapter 14: Permissions and Authorization
279
New article link
Authorizations
There are multiple issues around the lack of authorizations in our current project.
Obviously we would like to restrict access to only users so we have the option of one
day charging readers to our newspaper. But beyond that, any random logged-out user
who knows the correct URL can access any part of the site.
Consider what would happen if a logged-out user tried to create a new article? To try
it out, click on your username in the upper right corner of the nav bar, then select
“Log out” from the dropdown options. The “+ New” link disappears from the nav bar
but what happens if you go to it directly: http://127.0.0.1:8000/articles/new/?
The page is still there.Chapter 14: Permissions and Authorization
Logged out new
Now try to create a new article with a title and body. Click on the “Save” button.
Create page error
280Chapter 14: Permissions and Authorization
281
An error. This is because our model expects an author field which is linked to the
current logged-in user. But since we are not logged in, there’s no author, and therefore
the submission fails.
Mixins
We clearly want to set some authorizations so only logged-in users can access the
site. To do this we can use a mixin, which is a special kind of multiple inheritance that
Django uses to avoid duplicate code and allow for customization. For example, the
built-in generic ListView needs a way to return a template. But so does DetailView and
in fact almost every other view. Rather than repeat the same code in each big generic
view, Django breaks out this functionality into a “mixin” known as TemplateRespon-
seMixin. Both ListView and DetailView use this mixin to render the proper template.
If you read the Django source code, which is freely available on Github, you’ll see
mixins used all over the place.
To restrict view access to only logged in users, Django has a LoginRequired mixin that
we can use. It’s powerful and extremely concise.
Within the existing articles/views.py file import it at the top and then add Login-
RequiredMixin to our ArticleCreateView . Make sure that the mixin is to the left of
ListView so it will be read first. We want the ListView to already know we intend to
restrict access.
And that’s it! We’re done.282
Chapter 14: Permissions and Authorization
Code</p>
<h1 id="articlesviewspy_1">articles/views.py</h1>
<p>from django.contrib.auth.mixins import LoginRequiredMixin # new
...
class ArticleCreateView(LoginRequiredMixin, CreateView): # new
...
Now return to the URL for creating new messages at http://127.0.0.1:8000/articles/new/
and you’ll see the following error:
Error page
What’s happening? Django has automatically redirected us to the default location for
the login page which is at /accounts/login however if you recall, in our project-level
URLs we are using users/ as our route. That’s why our login page is at users/login .
So how do we tell our ArticleCreateView about this?
If you look at the documentation for LoginRequired mixin it tells us the answer. We
can add a login_url to override the default parameter. We’re using the named URL of
our login route here login .Chapter 14: Permissions and Authorization
283
Code</p>
<h1 id="articlesviewspy_2">articles/views.py</h1>
<p>...
class ArticleCreateView(LoginRequiredMixin, CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body',]
login_url = 'login' # new
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
Try the link for creating new messages again: http://127.0.0.1:8000/articles/new/.
It now redirects users to the login page. Just as we desired!
Updating views
Now we see that restricting view access is just a matter of adding LoginRequiredMixin
at the beginning of all existing views and specifying the correct login_url . Let’s update
the rest of our articles views since we don’t want a user to be able to create, read,
update, or delete a message if they aren’t logged in.
The complete views.py file should now look like this:Chapter 14: Permissions and Authorization
Code</p>
<h1 id="articlesviewspy_3">articles/views.py</h1>
<p>from django.contrib.auth.mixins import LoginRequiredMixin
from django.views.generic import ListView, DetailView
from django.views.generic.edit import CreateView, UpdateView, DeleteView
from django.urls import reverse_lazy
from . import models
class ArticleListView(LoginRequiredMixin, ListView):
model = models.Article
template_name = 'article_list.html'
login_url = 'login'
class ArticleDetailView(LoginRequiredMixin, DetailView):
model = models.Article
template_name = 'article_detail.html'
login_url = 'login'
class ArticleUpdateView(LoginRequiredMixin, UpdateView):
model = models.Article
fields = ['title', 'body', ]
template_name = 'article_edit.html'
login_url = 'login'
284Chapter 14: Permissions and Authorization
285
class ArticleDeleteView(LoginRequiredMixin, DeleteView):
model = models.Article
template_name = 'article_delete.html'
success_url = reverse_lazy('article_list')
login_url = 'login'
class ArticleCreateView(LoginRequiredMixin, CreateView):
model = models.Article
template_name = 'article_new.html'
fields = ['title', 'body', ]
login_url = 'login'
def form_valid(self, form):
form.instance.author = self.request.user
return super().form_valid(form)
Go ahead and play around with the site to confirm that the login redirects now work
as expected. If you need help recalling what the proper URLs are, log in first and write
down the URLs for each of the routes for create, edit, delete, and all articles.
Conclusion
Our Newspaper app is almost done. We have our articles properly configured, have set
permissions and authorizations, user authentication is in good shape. The last item is
to add the ability for fellow logged-in users to leave comments which we’ll cover in
the next chapter.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
