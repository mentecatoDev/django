<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>16 - Django</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "16";
    var mkdocs_page_input_path = "16.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../1_introduccion/">1. Introducción</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../2_configuracion_inicial/">2. Configuración Inicial</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../3_hello_world_app/">3. Hello World app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../4_pages_app/">4. Pages app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../5_message_board_app/">5. Message Board app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../6_blog_app/">6. Blog app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../7_formularios/">7. Formularios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../8_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../9_modelo_de_usuario_personalizado/">9. Modelo de Usuario Personalizado</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../11_bootstrap/">11. Bootstrap</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../13_email/">13. Email</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>16</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>Chapter
: Comments
There are two ways we could add comments to our Newspaper site. The first is to
create a dedicated comments app and link it to articles, however that seems like
over-engineering at this point. Instead we can simply add an additional model called
Comment to our articles app and link it to the Article model through a foreign key. By
the end of this chapter users will have the ability to leave comments on any other
users articles.
Model
To start we can add another table to our existing database called Comment . This model
will have a many-to-one foreign key relationship to Article : one article can have many
comments, but not the other way around. Traditionally the name of the foreign key
field is simply the model it links to, so this field will be called article . The other two
fields will be comment and author .
Open up the file articles/models.py and underneath the existing code add the
following.287
Chapter 15: Comments
Code</p>
<h1 id="articlesmodelspy">articles/models.py</h1>
<p>...
class Comment(models.Model):
article = models.ForeignKey(Article, on_delete=models.CASCADE)
comment = models.CharField(max_length=
)
author = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
)
def <strong>str</strong>(self):
return self.comment
def get_absolute_url(self):
return reverse('article_list')
Our Comment model also has a <strong>str</strong> method and a get_absolute_url method that
returns to the main articles/ page.
Since we’ve updated our models it’s time to make a new migration file and then apply
it. Note that by adding articles at the end of each command–which is optional–we
are specifying we want to use just the articles app here. This is a good habit to use.
For example, what if we made changes to models in two different apps? If we did not
specify an app, then both apps’ changes would be incorporated in the same migrations
file which makes it harder, in the future, to debug errors. Keep each migration as small
and contained as possible.Chapter 15: Comments
288
Command Line
(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
Admin
After making a new model it’s good to play around with it in the admin app before
displaying it on our actual website. Add Comment to our admin.py file so it will be visible.
Code</p>
<h1 id="articlesadminpy">articles/admin.py</h1>
<p>from django.contrib import admin
from . import models
admin.site.register(models.Article)
admin.site.register(models.Comment)
Then start up the server with python manage.py runserver and navigate to our main
page http://127.0.0.1:8000/admin/289
Chapter 15: Comments
Admin page with Comments
Under our app “Articles” you’ll see our two tables: Comments and Articles. Click on
the “+ Add” next to Comments. You’ll see that under Article is a dropdown of exiting
articles, same thing for Author, and there is a text field next to Comment.290
Chapter 15: Comments
Admin Comments
Select an Article, write a comment, and then select an author that is not your
superuser, perhaps testuser as I’ve done in the picture. Then click on the “Save”
button.
You should next see your comment on the “Comments” page.291
Chapter 15: Comments
Admin Comment One
At this point we could add an additional admin field so we’d see the comment and the
article on this page. But wouldn’t it be better to just see all Comment models related to
a single Post model? It turns out we can with a Django admin feature called inlines
which displays foreign key relationships in a nice, visual way.
There are two main inline views used: TabularInline and StackedInline. The only dif-
ference between the two is the template for displaying information. In a TabularInline
all model fields appear on one line while in a StackedInline each field has its own line.
We’ll implement both so you can decide which one you prefer.
Update articles/admin.py as follows in your text editor.Chapter 15: Comments
292
Code</p>
<h1 id="articlesadminpy_1">articles/admin.py</h1>
<p>from django.contrib import admin
from . import models
class CommentInline(admin.StackedInline):
model = models.Comment
class ArticleAdmin(admin.ModelAdmin):
inlines = [
CommentInline,
]
admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
Now go back to the main admin page at http://127.0.0.1:8000/admin/ and click on
“Articles.” Select the article which you just added a comment for which was “Local
news” in my case.293
Chapter 15: Comments
Admin change page
Better right! We can see and modify all our related articles and comments in one place.
Personally though I prefer using TabularInline as it shows more information in
less space. To switch to to it we only need to change our CommentInline from
admin.StackedInline to admin.TabularInline .Chapter 15: Comments
294
Code</p>
<h1 id="articlesadminpy_2">articles/admin.py</h1>
<p>from django.contrib import admin
from . import models
class CommentInline(admin.TabularInline):
model = models.Comment
class ArticleAdmin(admin.ModelAdmin):
inlines = [
CommentInline,
]
admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
Refresh the admin page and you’ll see the new change: all fields for each model are
displayed on the same line.295
Chapter 15: Comments
TabularInline page
Much better. Now we need to update our template to display comments.
Template
Since Comment lives within our existing articles app we only need to update the
existing templates for article_list.html and article_detail.html to display our new
content. We don’t have to create new templates and mess around with urls and views.
What we want to do is display all comments related to a specific article. This is
called a “query” as we’re asking the database for a specific bit of information. In our
case, working with a foreign key, we want to follow a relationship backward: for each
Article look up related Comment models.Chapter 15: Comments
296
Django has a built-in syntax we can use known as FOO_set where FOO is the lowercased
source model name. So for our Article model we can use article_set to access all
instances of the model.
But personally I strongly dislike this syntax as I find it confusing and non-intuitive. A
better approach is to add a related_name attribute to our model which lets us explicitly
set the name of this reverse relationship instead. Let’s do that.
To start add a related_name attribute to our Comment model. A good default is to name
it the plural of the model holding the ForeignKey.
Code</p>
<h1 id="articlesmodelspy_1">articles/models.py</h1>
<p>...
class Comment(models.Model):
article = models.ForeignKey(
Article,
on_delete=models.CASCADE,
related_name='comments' # new
)
Since we just made a change to our database model we need to create a migrations
file and update the database. Stop the local server with Control+c and execute the
following two commands. Then spin up the server again as we will be using it shortly.Chapter 15: Comments
297
Command Line
(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
(news) $ python manage.py runserver
Understanding queries takes some time so don’t be concerned if the idea of reverse
relationships is confusing. I’ll show you how to implement the code as desired. And
once you’ve mastered these basic cases you can explore how to filter your querysets
in great detail so they return exactly the information you want.
In our article_list.html file we can add our comments to the card-footer . Note
that I’ve moved our edit and delete links up into card-body . To access each comment
we’re calling article.comments.all which means first look at the article model,
then comments which is the related name of the entire Comment model, and select all
included. It can take a little while to become accustomed to this syntax for referencing
foreign key data in a template!
Code
<!-- template/article_list.html -->
{% extends 'base.html' %}
{% block title %}Articles{% endblock %}
{% block content %}
{% for article in object_list %}
<div class="card">
<div class="card-header">
<span class="font-weight-bold">{{ article.title }}</span> &middot;
<span class="text-muted">by {{ article.author }} | {{ article.date }}</s\Chapter 15: Comments
298
pan>
</div>
<div class="card-body">
<p>{{ article.body }}</p>
<a href="{% url 'article_edit' article.pk %}">Edit</a> |
<a href="{% url 'article_delete' article.pk %}">Delete</a>
</div>
<div class="card-footer">
{% for comment in article.comments.all %}
<p>
<span class="font-weight-bold">{{ comment.author }} &middot;</span>
{{ comment }}
</p>
{% endfor %}
</div>
</div>
<br />
{% endfor %}
{% endblock content %}
If you refresh the articles page at http://127.0.0.1:8000/articles/ we can see our new
comment displayed on the page.299
Chapter 15: Comments
Articles page with comments
Yoohoo! It works. We can see both comments listed underneath the initial message.
Conclusion
With more time we would focus on forms now so a user could write a new article
directly on the articles/ page as well as add comments too. But the main focus of
this chapter is to demonstrate how foreign key relationships work in Django.
Our Newspaper app is now complete. It has a robust user authentication flow
including the use of email for password resets. We are also using a custom user model
so if we want to add additional fields to our CustomUser model it is as simple as addingChapter 15: Comments
300
an additional field. We already have an age field for all users that is currently being set
to
by default. If we wanted to, we could add an age dropdown to the signup form
and restrict user access only to users over age 13. Or we could offer discounts to users
over age 65. Whatever we want to do to our CustomUser model is an option.
Most of web development follows the same patterns and by using a web framework
like Django 99% of what we want in terms of functionality is either already included
or only a small customization of an existing feature away.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
