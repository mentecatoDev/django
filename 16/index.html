<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Comentarios - Django</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Comentarios";
    var mkdocs_page_input_path = "16.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../1_introduccion/">1. Introducción</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../2_configuracion_inicial/">2. Configuración Inicial</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../3_hello_world_app/">3. Hello World app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../4_pages_app/">4. Pages app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../5_message_board_app/">5. Message Board app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../6_blog_app/">6. Blog app</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../7_formularios/">7. Formularios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../8_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../9_modelo_de_usuario_personalizado/">9. Modelo de Usuario Personalizado</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../11_bootstrap/">11. Bootstrap</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../13_email/">13. Email</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../14_newspaper_app/">14. Newspaper app</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Comentarios</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="comentarios">Comentarios</h1>
<p>Hay dos maneras en las que podríamos añadir comentarios a nuestro sitio web del periódico. La primera es crear una aplicación de comentarios dedicada y enlazarla a los artículos, sin embargo eso parece una sobreingeniería en este momento. En su lugar podemos simplemente añadir un modelo adicional llamado Comentario a nuestra aplicación de artículos y enlazarlo al modelo de Artículo a través de una clave externa. Al final de este capítulo los usuarios tendrán la posibilidad de dejar comentarios en los artículos de cualquier otro usuario.
Modelo
Para empezar podemos añadir otra tabla a nuestra base de datos existente llamada Comentario . Este modelo tendrá una relación clave de muchos a uno con el artículo: un artículo puede tener muchos comentarios, pero no al revés. Tradicionalmente el nombre del campo de la clave extranjera es simplemente el modelo con el que se vincula, por lo que este campo se llamará artículo . Los otros dos campos serán comentario y autor .
Abra el archivo articles/models.py y debajo del código existente añada lo siguiente. Comentarios</p>
<p>FICHERO: <code>articles/models.py</code></p>
<pre><code>...
class Comment(models.Model):
article = models.ForeignKey(Article, on_delete=models.CASCADE)
comment = models.CharField(max_length=
)
author = models.ForeignKey(
settings.AUTH_USER_MODEL,
on_delete=models.CASCADE,
)
def __str__(self):
return self.comment
def get_absolute_url(self):
return reverse('article_list')
</code></pre>

<p>Nuestro modelo de comentarios también tiene un método <strong>str</strong> y un método get_absolute_url que regresa a la página principal de artículos.
Ya que hemos actualizado nuestros modelos, es hora de hacer un nuevo archivo de migración y luego aplicarlo. Tengan en cuenta que al añadir artículos al final de cada comando, lo cual es opcional, estamos especificando que queremos usar sólo la aplicación de artículos aquí. Este es un buen hábito para usar.
Por ejemplo, ¿qué pasaría si hiciéramos cambios en los modelos de dos aplicaciones diferentes? Si no especificamos una aplicación, entonces los cambios de ambas aplicaciones se incorporarán en el mismo archivo de migraciones, lo que hace más difícil, en el futuro, depurar los errores. Mantén cada migración tan pequeña y contenida como sea posible.</p>
<pre><code>(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
</code></pre>

<p>Admin
Después de hacer un nuevo modelo es bueno jugar con él en la aplicación de administración antes de mostrarlo en nuestro sitio web real. Añade el comentario a nuestro archivo admin.py para que sea visible.</p>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code>from django.contrib import admin
from . import models
admin.site.register(models.Article)
admin.site.register(models.Comment)
</code></pre>

<p>Luego inicia el servidor con python manage.py runserver y navega a nuestra página principal http://127.0.0.1:8000/admin/</p>
<p>Página de administración con comentarios
En nuestra aplicación "Artículos" verás nuestras dos mesas: Comentarios y Artículos. Haga clic en el "+ Agregar" junto a Comentarios. Verás que en "Artículo" hay un desplegable de artículos salientes, lo mismo para "Autor", y hay un campo de texto junto a "Comentario".</p>
<p>Admin Comentarios
Selecciona un artículo, escribe un comentario y luego selecciona un autor que no sea tu superusuario, tal vez un testusuario como he hecho en la foto. Luego haz clic en el botón "Guardar".
A continuación deberías ver tu comentario en la página de "Comentarios".</p>
<p>Admin Comentario Uno
En este punto podríamos añadir un campo de administración adicional para ver el comentario y el artículo en esta página. ¿Pero no sería mejor ver todos los modelos de comentarios relacionados con un solo modelo de Post? Resulta que sí, con una función de administración de Django llamada inlines que muestra las relaciones de claves externas de una manera visual y agradable.
Se utilizan dos vistas en línea principales: TabularInline y StackedInline. La única diferencia entre las dos es el modelo para mostrar la información. En una TabularInline todos los campos del modelo aparecen en una línea mientras que en una StackedInline cada campo tiene su propia línea.
Implementaremos ambos para que puedas decidir cuál prefieres.
Actualiza los artículos/admin.py como sigue en tu editor de texto.</p>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code>from django.contrib import admin
from . import models
class CommentInline(admin.StackedInline):
model = models.Comment
class ArticleAdmin(admin.ModelAdmin):
inlines = [
CommentInline,
]
admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
</code></pre>

<p>Ahora vuelve a la página principal de administración en http://127.0.0.1:8000/admin/ y haz clic en "Artículos". Selecciona el artículo al que acabas de añadir un comentario que en mi caso era "Noticias locales".
Página de cambio de administración
¡Mejor a la derecha! Podemos ver y modificar todos nuestros artículos y comentarios relacionados en un solo lugar. Personalmente prefiero usar TabularInline ya que muestra más información en menos espacio. Para cambiar a él sólo tenemos que cambiar nuestro CommentInline de admin.StackedInline a admin.TabularInline .</p>
<p>FICHERO: <code>articles/admin.py</code></p>
<pre><code>from django.contrib import admin
from . import models
class CommentInline(admin.TabularInline):
model = models.Comment
class ArticleAdmin(admin.ModelAdmin):
inlines = [
CommentInline,
]
admin.site.register(models.Article, ArticleAdmin)
admin.site.register(models.Comment)
</code></pre>

<p>Actualice la página de administración y verá el nuevo cambio: todos los campos de cada modelo se muestran en la misma línea.
Página TabularInline
Mucho mejor. Ahora necesitamos actualizar nuestra plantilla para mostrar los comentarios.
Plantilla
Dado que Comment vive dentro de nuestra aplicación de artículos existentes, sólo necesitamos actualizar las plantillas existentes para article_list.html y article_detail.html para mostrar nuestro nuevo contenido. No tenemos que crear nuevas plantillas y jugar con las urls y las vistas. Lo que queremos hacer es mostrar todos los comentarios relacionados con un artículo específico. Esto se llama "consulta" ya que estamos pidiendo a la base de datos una información específica. En nuestro caso, al trabajar con una clave extranjera, queremos seguir una relación hacia atrás: para cada artículo buscar modelos de comentarios relacionados.
Django tiene una sintaxis incorporada que podemos usar conocida como FOO_set donde FOO es el nombre del modelo de fuente en minúsculas. Así que para nuestro modelo de Artículo podemos usar article_set para acceder a todas las instancias del modelo.
Pero personalmente me disgusta mucho esta sintaxis ya que la encuentro confusa y no intuitiva. Un mejor enfoque es añadir un atributo related_name a nuestro modelo que nos permita establecer explícitamente el nombre de esta relación inversa en su lugar. Hagámoslo.
Para empezar, agrega un atributo related_name a nuestro modelo de comentarios. Un buen valor por defecto es nombrarlo en el plural del modelo que contiene la llave extranjera.</p>
<p>FICHERO: <code>articles/models.py</code></p>
<pre><code>...
class Comment(models.Model):
article = models.ForeignKey(
Article,
on_delete=models.CASCADE,
related_name='comments' # new
)
</code></pre>

<p>Como acabamos de hacer un cambio en nuestro modelo de base de datos, necesitamos crear un archivo de migraciones y actualizar la base de datos. Detenga el servidor local con Control+c y ejecute los siguientes dos comandos. Luego gire el servidor de nuevo ya que lo usaremos en breve.
Command Line</p>
<pre><code>(news) $ python manage.py makemigrations articles
(news) $ python manage.py migrate
(news) $ python manage.py runserver
</code></pre>

<p>Entender las consultas lleva algún tiempo, así que no se preocupe si la idea de las relaciones inversas es confusa. Te mostraré cómo implementar el código como se desea. Y una vez que domine estos casos básicos, puede explorar cómo filtrar sus consultas con gran detalle para que devuelvan exactamente la información que desea.
En nuestro archivo article_list.html podemos añadir nuestros comentarios al pie de la tarjeta. Note que he movido nuestros enlaces de edición y borrado al cuerpo de la tarjeta. Para acceder a cada comentario llamamos a article.comments.all lo que significa que primero miramos el modelo de artículo, luego los comentarios que es el nombre relacionado de todo el modelo de comentario, y seleccionamos todo incluido. Puede llevar un poco de tiempo acostumbrarse a esta sintaxis para referenciar datos de claves extranjeras en un modelo!</p>
<p>FICHERO: <code>template/article_list.html</code></p>
<pre><code>{% extends 'base.html' %}
{% block title %}Articles{% endblock %}
{% block content %}
{% for article in object_list %}
&lt;div class=&quot;card&quot;&gt;
&lt;div class=&quot;card-header&quot;&gt;
&lt;span class=&quot;font-weight-bold&quot;&gt;{{ article.title }}&lt;/span&gt; &amp;middot;
&lt;span class=&quot;text-muted&quot;&gt;by {{ article.author }} | {{ article.date }}&lt;/s\pan&gt;
&lt;/div&gt;
&lt;div class=&quot;card-body&quot;&gt;
&lt;p&gt;{{ article.body }}&lt;/p&gt;
&lt;a href=&quot;{% url 'article_edit' article.pk %}&quot;&gt;Edit&lt;/a&gt; |
&lt;a href=&quot;{% url 'article_delete' article.pk %}&quot;&gt;Delete&lt;/a&gt;
&lt;/div&gt;
&lt;div class=&quot;card-footer&quot;&gt;
{% for comment in article.comments.all %}
&lt;p&gt;
&lt;span class=&quot;font-weight-bold&quot;&gt;{{ comment.author }} &amp;middot;&lt;/span&gt;
{{ comment }}
&lt;/p&gt;
{% endfor %}
&lt;/div&gt;
&lt;/div&gt;
&lt;br /&gt;
{% endfor %}
{% endblock content %}
</code></pre>

<p>Si actualiza la página de artículos en http://127.0.0.1:8000/articles/ podemos ver nuestro nuevo comentario en la página.
Página de artículos con comentarios
Yoohoo! Funciona. Podemos ver ambos comentarios listados debajo del mensaje inicial.</p>
<h2 id="conclusion">Conclusión</h2>
<p>Con más tiempo nos centraríamos en los formularios ahora para que un usuario pueda escribir un nuevo artículo directamente en la página de artículos, así como añadir comentarios también. Pero el principal objetivo de este capítulo es demostrar cómo funcionan las relaciones clave extranjeras en Django.
Nuestra aplicación para el periódico ya está completa. Tiene un flujo de autenticación de usuario robusto, incluyendo el uso del correo electrónico para el restablecimiento de la contraseña. También estamos utilizando un modelo de usuario personalizado, por lo que si queremos añadir campos adicionales a nuestro modelo de usuario personalizado es tan sencillo como añadir un campo adicional. Ya tenemos un campo de edad para todos los usuarios que está siendo configurado por defecto. Si quisiéramos, podríamos añadir un desplegable de edad al formulario de registro y restringir el acceso de los usuarios sólo a los mayores de 13 años. O podríamos ofrecer descuentos a los usuarios mayores de 65 años. Lo que queramos hacer con nuestro modelo de usuario personalizado es una opción.
La mayor parte del desarrollo web sigue los mismos patrones y al utilizar un marco web como Django el 99% de lo que queremos en términos de funcionalidad ya está incluido o sólo falta una pequeña personalización de una función existente.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
