<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>9. Modelo de Usuario Personalizado - Django</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "9. Modelo de Usuario Personalizado";
    var mkdocs_page_input_path = "09_modelo_de_usuario_personalizado.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../00_por_que_django/">¿Por qué Django?</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../01_introduccion/">1. Introducción</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../02_configuracion_inicial/">2. Configuración Inicial</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../03_hello_world_app/">3. Hello World app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../04_pages_app/">4. Pages app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../05_message_board_app/">5. Message Board app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../06_blog_app/">6. Blog app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../07_formularios/">7. Formularios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../08_cuentas_de_usuarios/">8. Cuentas de Usuarios</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">9. Modelo de Usuario Personalizado</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#91-setup">9.1. Setup</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#92-modelo-de-usuario-personalizado">9.2 Modelo de usuario personalizado</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#abstractbaseuser-vs-abstractuser">AbstractBaseUser vs AbstractUser</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#93-formularios">9.3. Formularios</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#94-superusuario">9.4. Superusuario</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#95-conclusion">9.5. Conclusión</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../10_autenticacion_de_usuarios/">10. Autenticación de Usuarios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../11_bootstrap/">11. Bootstrap</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../12_cambio_y_restauracion_de_contrasenas/">12. Cambio y Restauración de Contraseñas</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../13_email/">13. Email</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../14_newspaper_app/">14. Newspaper app</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../15_permisos_y_autorizacion/">15. Permisos y Autorización</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../16_comentarios/">16. Comentarios</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../17_docker/">17. Docker</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../portfolio/portfolio/">Portafolio</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>9. Modelo de Usuario Personalizado</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="9-modelo-de-usuario-personalizado">9. Modelo de usuario personalizado</h1>
<p>La documentación oficial de Django recomienda encarecidamente utilizar un <strong>modelo de usuario personalizado</strong> para los nuevos proyectos. La razón es que si se quiere hacer cualquier cambio en el modelo de usuario en el futuro -por ejemplo, añadir un campo edad- utilizar un modelo de usuario personalizado desde el principio lo convierte en algo sencillo. Pero si <strong>no</strong> se crea, <strong>actualizar el modelo de usuario</strong> por defecto en un proyecto Django existente es muy, <strong>muy difícil</strong>.</p>
<p>Sin embargo, el ejemplo de la documentación oficial no es realmente lo que muchos expertos en Django recomiendan. Utilizar el complejo <code>AbstractBaseUser</code> cuando si sólo se utiliza <code>AbstractUser</code> las cosas son mucho más sencillas y aún así personalizables es mucho mejor práctica.</p>
<p>Y ahora, <strong>hagamos un periódico</strong> (homenaje a las raíces de Django como un framework construido para editores y periodistas en el <a href="https://en.wikipedia.org/wiki/Lawrence_Journal-World">Lawrence Journal-World</a>).</p>
<h2 id="91-setup">9.1. Setup</h2>
<pre><code class="language-bash">$ cd ~/Desktop
$ mkdir news
$ cd news
$ pipenv install django
$ pipenv shell
(news) $ django-admin startproject newspaper_project .
(news) $ python manage.py startapp accounts
(news) $ python manage.py runserver
</code></pre>
<p>Tener en cuenta que aún <strong>no se ha ejecutado la migración</strong> para configurar la base de datos.</p>
<blockquote>
<p>Nota</p>
<p>Es importante <strong>esperar hasta después</strong> de que se haya creado el nuevo modelo de usuario personalizado, dado lo <strong>estrechamente conectado que está el modelo de usuario con el resto de Django</strong>.</p>
</blockquote>
<h2 id="92-modelo-de-usuario-personalizado">9.2 Modelo de usuario personalizado</h2>
<p>La creación del modelo de usuario personalizado requiere cuatro pasos:</p>
<ul>
<li>Actualizar <code>settings.py</code></li>
<li>Crear un nuevo modelo <code>CustomUser</code> añadiendo un nuevo campo <code>age</code></li>
<li>Crear nuevos formularios para <code>UserCreation</code> y <code>UserChangeForm</code></li>
<li>Actualizar la app <code>admin</code></li>
</ul>
<p>FICHERO: <code>newspaper_project/settings.py</code></p>
<pre><code class="language-python">INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'account.apps.AccountsConfig',                          # new
]
...
# Authentication                                          # new
AUTH_USER_MODEL = 'accounts.CustomUser'                   # new
</code></pre>
<p>FICHERO: <code>accounts/models.py</code></p>
<pre><code class="language-python">from django.contrib.auth.models import AbstractUser
from django.db import models


class CustomUser(AbstractUser):
    age = models.PositiveIntegerField(null=True, blank=True, verbose_name=&quot;Edad&quot;)
</code></pre>
<p>Si leemos la documentación oficial sobre modelos de usuario personalizados, ésta recomienda usar <code>AbstractBaseUser</code> en lugar de <code>AbstractUser</code> lo cual trae consigo complicaciones innecesarias; sobre todo para los novatos.</p>
<blockquote>
<h4 id="abstractbaseuser-vs-abstractuser"><code>AbstractBaseUser</code> vs <code>AbstractUser</code></h4>
<p><code>AbstractBaseUser</code> requiere un nivel muy fino de control y personalización. Esencialmente reescribimos Django. Esto puede ser útil, pero si sólo queremos un modelo de usuario personalizado que se pueda actualizar con algunos campos adicionales, la mejor opción es <code>AbstractUser</code>, que es una subclase de <code>AbstractBaseUser</code>.
En otras palabras, escribimos mucho menos código y tenemos menos oportunidades de estropear las cosas. Es la mejor opción a menos que realmente sepas lo que estás haciendo con Django.</p>
</blockquote>
<p>Tenga en cuenta que utilizamos tanto <code>null</code> como <code>blank</code> con nuestro campo <code>age</code>. Estos dos términos son fáciles de confundir pero son bastante distintos:
- <code>null</code> está relacionado con la <strong>base de datos</strong>. Cuando un campo tiene <code>null=True</code> puede almacenar una entrada de la base de datos como NULL, es decir, sin valor.
- <code>blank</code> está relacionado con <strong>la validación</strong>, si <code>blank=True</code> un formulario permitirá un valor vacío, mientras que si <code>blank=False</code> se requiere un valor.</p>
<p>En la práctica, <code>null</code> y <code>blank</code> se utilizan comúnmente juntos de esta manera para que un formulario permita un valor vacío y la base de datos almacene ese valor como <code>NULL</code>.</p>
<p>Un problema común que hay que tener en cuenta es que el tipo de campo dicta cómo utilizar estos valores. Siempre que el campo esté basado en cadenas de caracteres, como <code>CharField</code> o <code>TextField</code>, si se establece tanto <code>null</code> como <code>blank</code>, como hemos hecho, resultará en dos valores posibles para "sin datos" en la base de datos. Lo cual es una mala idea. La convención de Django es usar la cadena vacía <code>''</code>, no NULL.</p>
<h2 id="93-formularios">9.3. Formularios</h2>
<p>Hay <strong>dos formas</strong> de interactuar con el <strong>nuevo modelo</strong> de usuario personalizado</p>
<ul>
<li>Cuando un usuario se <strong>registra</strong> para una nueva cuenta en el sitio web</li>
<li>Dentro de la <strong>aplicación de administración</strong> que permite, como superusuarios, modificar los usuarios existentes.</li>
</ul>
<p>Así que hay que actualizar los dos formularios incorporados para esta funcionalidad: <code>UserCreationForm</code> y <code>UserChangeForm</code>.</p>
<pre><code class="language-bash">(noticias) $ touch accounts/forms.py
</code></pre>
<p>FICHERO: <code>accounts/forms.py</code></p>
<pre><code class="language-python">from django.contrib.auth.forms import UserCreationForm, UserChangeForm
from .models import CustomUser


class CustomUserCreationForm(UserCreationForm):

    class Meta(UserCreationForm):
        model = CustomUser
        fields = UserCreationForm.Meta.fields


class CustomUserChangeForm(UserChangeForm):

    class Meta:
        model = CustomUser
        fields = UserChangeForm.Meta.fields
</code></pre>
<p>Para ambos formularios se usa el modelo <code>CustomUser</code> con los campos por defecto de <code>Meta.fields</code>.</p>
<p>El modelo de <code>CustomUser</code> contiene todos los campos del modelo de usuario por defecto y el campo <code>age</code> adicional que se ha definido.</p>
<p>Para los nuevos formularios usamos la clase <code>Meta</code> para anular los campos por defecto estableciendo el
modelo a nuestro <code>CustomUser</code> y utilizando los campos por defecto a través de <code>Meta.fields</code> que incluye todos los campos por defecto. Para añadir nuestro campo <code>age</code> personalizado simplemente lo añadimos al final y se mostrará automáticamente en nuestra futura página de registro. Bastante ingenioso, ¿no?.
El concepto de campos en un formulario puede ser confuso al principio, así que vamos a dedicar un momento a explorarlo más a fondo. Nuestro modelo <code>CustomUser</code> contiene todos los campos del modelo <code>User</code> por defecto y el campo adicional que hemos establecido.</p>
<p>¿Pero cuáles son estos campos por defecto?</p>
<p>Resulta que hay muchos, incluyendo <code>username</code>, <code>first_name</code>, <code>last_name</code>, <code>email</code>, <code>password</code>, <code>groups</code> y más.</p>
<p>Sin embargo, cuando un usuario se registra en una nueva cuenta en Django, el formulario predeterminado sólo pide un nombre de usuario, un correo electrónico y una contraseña.</p>
<p>Esto nos dice que la configuración predeterminada para los campos en <code>UserCreationForm</code> son sólo el <code>username</code>,  <code>email</code> y <code>password</code> aunque hay muchos más campos disponibles.</p>
<p>Por tanto, entender los formularios y los modelos correctamente lleva algún tiempo.</p>
<p>El paso final es actualizar el archivo <code>admin.py</code> ya que <em>Admin</em> está estrechamente unido al modelo de usuario por defecto. Se extenderá la clase existente <code>UserAdmin</code> para usar el nuevo modelo de <code>CustomUser</code> y los dos nuevos formularios.</p>
<p>FICHERO: <code>accounts/admin.py</code></p>
<pre><code class="language-python">from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .forms import CustomUserCreationForm, CustomUserChangeForm
from .models import CustomUser


class CustomUserAdmin(UserAdmin):
    add_form = CustomUserCreationForm
    form = CustomUserChangeForm
    model = CustomUser


admin.site.register(CustomUser, CustomUserAdmin)
</code></pre>
<p>Ejecutar <code>makemigrations</code> y <code>migrate</code> por primera vez para crear una nueva base de datos que utilice el modelo de usuario personalizado.</p>
<pre><code class="language-bash">(news) $ python manage.py makemigrations
(news) $ python manage.py migrate
</code></pre>
<h2 id="94-superusuario">9.4. Superusuario</h2>
<p>Vamos a crear una cuenta de superusuario para confirmar que todo funciona como se espera. En la línea de comandos, escribir el siguiente comando y cumplir con las indicaciones.</p>
<pre><code class="language-bash">(news) $ python manage.py createsuperuser
</code></pre>
<p>El hecho de que esto funcione es la primera prueba de que el modelo de usuario personalizado funciona como se esperaba.</p>
<ul>
<li>Navegar a http://127.0.0.1:8000/admin, logear y probar. Si haces clic en el enlace para "Usuarios", se debería ver la cuenta de superusuario, así como los campos predeterminados de Nombre de usuario
  Dirección de correo electrónico, Nombre, Apellido y Estado del personal.</li>
</ul>
<p>Para controlar los campos listados aquí se utiliza <code>list_display</code>. Sin embargo, para editar y añadir nuevos campos personalizados, como la edad, debemos añadir también <code>fieldsets</code>.</p>
<p>FICHERO: <code>accounts/admin.py</code></p>
<pre><code class="language-python">from django.contrib import admin
from django.contrib.auth.admin import UserAdmin

from .forms import CustomUserCreationForm, CustomUserChangeForm
from .models import CustomUser


class CustomUserAdmin(UserAdmin):
    add_form = CustomUserCreationForm
    form = CustomUserChangeForm
    model = CustomUser
    list_display = ['email', 'username', 'age', 'is_staff', ]
    fieldsets = UserAdmin.fieldsets + ((None, {'fields': ('age',)}),)
    add_fieldsets = UserAdmin.add_fieldsets + ((None, {'fields':('age',)}),)


admin.site.register(CustomUser, CustomUserAdmin)
</code></pre>
<ul>
<li>Actualizar la página y ver el resultado</li>
</ul>
<h2 id="95-conclusion">9.5. Conclusión</h2>
<p>Con el modelo de usuario personalizado completo, ahora podemos centrarnos en construir el resto de la aplicación <em>Newspaper</em>.</p>
<p>|\/| [- || ~|~ [- ( /\ ~|~ () ^/_ '|</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../10_autenticacion_de_usuarios/" class="btn btn-neutral float-right" title="10. Autenticación de Usuarios">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../08_cuentas_de_usuarios/" class="btn btn-neutral" title="8. Cuentas de Usuarios"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../08_cuentas_de_usuarios/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../10_autenticacion_de_usuarios/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
